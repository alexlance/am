#!/bin/bash
set -uo pipefail
[ "${#}" -eq 0 ] && echo "usage: $(basename $0) <hostname> [command]" && exit 1

region="ap-southeast-2"
[ "${1:0:3}" == "us-" ] && region="us-west-2"

results=$(
  aws ec2 describe-instances \
    --region ${region} \
    --filters \
      "Name=tag:Name,Values=*${1}*" \
      "Name=instance-state-name,Values=running" \
    --query \
      "sort_by(Reservations[*].Instances[].{name:Tags[?Key=='Name'] | [0].Value, \
      id:InstanceId, ip:PrivateIpAddress, type:InstanceType, az:Placement.AvailabilityZone, ami:ImageId \
      role:IamInstanceProfile.Arn}, &name)"
)

ips=$(echo ${results} | jq -r '.[] | .ip')
if [ ${#} -gt 1 ]; then
  shift # drop hostname
  cmd="${@}"
  if [[ "${cmd}" == *"sudo "* ]]; then
    read -p 'Enter sudo password: ' -s password
    cmd=${cmd//sudo/"echo \"${password}\" | sudo -p' ' -S"}
  fi
  for i in ${ips}; do
    echo "* ${i}: ${@}"
    ssh -t -q -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${i} -- "${cmd}" || echo "Exited: ${?}"
  done
elif [ -t 1 ]; then
  echo ${results} | jq -r '.[] | [.name, .id, .ip, .az, .type, .ami, (.role|split("/")[1]) ] | join(" ")' | column -t
else
  echo ${ips}
fi
